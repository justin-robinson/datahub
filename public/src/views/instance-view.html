<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="property-view.html">

<dom-module id="instance-view">

    <template>
        <style>
            paper-card {
                width: 100%;
                --paper-card-background-color: var(--paper-grey-200);
            }

            paper-card paper-input,paper-autocomplete {
                width: 95%;
                padding-left:1em;
            }

            paper-icon-button.save {
                color: var(--paper-light-green-500);
            }

            paper-icon-button.delete {
                float:right;
                color: var(--paper-red-a200);
            }
            paper-icon-button.delete:hover {
                background-color: var(--paper-red-a200);
                color: white;
            }
        </style>

        <paper-card heading="{{data.name}}">
            <div>
                <paper-input value="{{data.companyInstanceId}}" label="Instance Id" on-change="companyInstanceIdChanged"></paper-input>
                <paper-input value="{{data.name}}" label="Name"></paper-input>
                <paper-input value="{{data.url}}" label="Url"></paper-input>
                <paper-input value="{{data.marketCode}}" label="Market Code"></paper-input>
                <paper-autocomplete value="{{data.stateId}}" id="stateSelector" text-property="name" value-property="stateId" label="State"></paper-autocomplete>
                <paper-input value="{{data.createdAt}}" label="Created"></paper-input>
                <paper-input value="{{data.updatedAt}}" label="Updated"></paper-input>
            </div>

            <div id="actions">

            </div>

            <paper-icon-button id="save" icon="save" on-click="save" class="save">Save</paper-icon-button>

            <template is="dom-if" if="{{data.companyInstanceId}}" as="self">
                <paper-icon-button id="delete" icon="delete" on-click="confirmDelete" class="delete">Delete</paper-icon-button>

                <template is="dom-if" if="{{properties.length}}">
                    <paper-icon-button id="showProperties" icon="build" on-click="showProperties">Properties</paper-icon-button>
                </template>

                <paper-dialog id="propertiesModal">
                    <h2>tst</h2>
                    <!--                        <template is="dom-repeat" items="{{property}}">-->
                    <!--                            <property-view data="{{item}}"></property-view>-->
                    <!--                        </template>-->
                    <!--            <div>{{states.fetched}}</div>-->
                    <!--            <paper-fab id="addProperty" icon="add" on-click="addPropertyClicked"></paper-fab>-->
                </paper-dialog>
            </template>
        </paper-card>

        <iron-ajax
            id="getState"
            auto
            handle-as="json"
            on-response="parseStateResponse"
        ></iron-ajax>

        <iron-ajax
            id="getProperties"
            auto
            handle-as="json"
            on-response="parseProperties"
        ></iron-ajax>

    </template>

    <script>
        (function () {

            var states = {
                "data": null,
                "sorted": null,
                "fetching": false,
                "fetched": false
            };

            var fetchedEvent = new Event('states-fetched');
            var element = document.createElement('div');

            Polymer({
                is: 'instance-view',
                properties: {
                    searchTimer: Object,
                    data: Object,
                    state: Object,
                    properties: Array
                },
                ready: function () {

                    this.data = this.data || {};
                    this.properties = this.properties || [];

                    this.companyInstanceIdChanged();

                    // get all the possible states from the api

                    // if we have already gotten the states, just attached them to autocomplete
                    if ( states.fetched ) {
                        this.$.stateSelector.source=states.data;
                        return;
                    }

                    // listen to the event fired when the states are fetched
                    var self = this;
                    element.addEventListener('states-fetched', function () {

                        // attach states to autocomplete
                        self.$.stateSelector.source=states.data;

                        // set current value of the autocomplete to the value of the instance
                        if ( !self.data.stateId ) {
                            return;
                        }
                        var state = states.sorted[self.data.stateId];
                        self.$.stateSelector.setOption({
                            text: state.name,
                            value: state.stateId
                        });
                    });

                    // first instance will do the actual api call for the states
                    if ( !states.fetching ) {
                        states.fetching = true;
                        this.$.getState.url = window.location.origin + '/api/v1/state';
                    }
                },
                parseStateResponse: function (event, request) {

                    // set flags that we have fetched the states
                    states.fetched = true;
                    states.fetching = false;

                    // save states api return
                    states.data = request.xhr.response;

                    // create map of stateId to state objects
                    states.sorted = {};
                    states.data.map(function(state){
                        states.sorted[state.stateId] = state;
                    });

                    // notify all other elements that the states have been fetched
                    element.dispatchEvent(fetchedEvent);
                },
                save: function () {
                    
                },
                companyInstanceIdChanged: function () {
                    if ( !this.data.companyInstanceId ) {
                        return;
                    }

                    clearTimeout(this.searchTimer);
                    var self = this;
                    this.searchTimer = setTimeout(function () {
                        self.$.getProperties.url = window.location.origin + '/api/v1/instance/' + self.data.companyInstanceId + '/properties'
                    });
                },
                parseProperties: function (event, request) {

                    if ( !request.xhr.response || !request.xhr.response._embedded || !request.xhr.response._embedded.properties.length ) {
                        return;
                    }

                    this.properties = request.xhr.response._embedded.properties;
                },
                showProperties: function () {
                    this.$.propertiesModal.open();
                }
            });
        })();
    </script>

</dom-module>
